-- Create vendor subscriptions master
CREATE TABLE public.vendor_subscriptions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id uuid NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,
  plan_type text NOT NULL CHECK (plan_type IN ('30k','40k','60k','custom')),
  subscription_start date NOT NULL,
  security_deposit_amount numeric NOT NULL DEFAULT 0,
  monthly_fee numeric NOT NULL DEFAULT 0,
  total_dish_value numeric NOT NULL DEFAULT 0,
  status text NOT NULL DEFAULT 'active' CHECK (status IN ('active','suspended','cancelled')),
  notes text,
  created_by uuid REFERENCES public.user_profiles(id) ON DELETE SET NULL,
  created_at timestamptz DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamptz DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN public.vendor_subscriptions.security_deposit_amount IS
  'Refundable security deposit amount (manual, independent of item totals)';

-- Items per vendor subscription
CREATE TABLE public.vendor_subscription_items (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL REFERENCES public.vendor_subscriptions(id) ON DELETE CASCADE,
  name text NOT NULL,
  size text,
  price_per_piece numeric NOT NULL DEFAULT 0,
  quantity integer NOT NULL DEFAULT 0,
  total numeric NOT NULL DEFAULT 0,
  created_at timestamptz DEFAULT CURRENT_TIMESTAMP
);

-- Helpful indexes
CREATE INDEX IF NOT EXISTS idx_vendor_subscriptions_vendor_id ON public.vendor_subscriptions(vendor_id);
CREATE INDEX IF NOT EXISTS idx_vendor_subscriptions_status ON public.vendor_subscriptions(status);
CREATE INDEX IF NOT EXISTS idx_vendor_subscription_items_subscription_id ON public.vendor_subscription_items(subscription_id);

-- Optional RLS (enable and basic policies if you use RLS)
-- ALTER TABLE public.vendor_subscriptions ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE public.vendor_subscription_items ENABLE ROW LEVEL SECURITY;
-- CREATE POLICY "authenticated_manage_vendor_subscriptions" ON public.vendor_subscriptions
--   FOR ALL TO authenticated USING (true) WITH CHECK (true);
-- CREATE POLICY "authenticated_manage_vendor_subscription_items" ON public.vendor_subscription_items
--   FOR ALL TO authenticated USING (true) WITH CHECK (true);